@startuml Add Booking (POST)

header Campground Booking System Sequence Diagram
footer Page %page% of %lastpage%
title "Add Booking (POST)"

participant "Client" as client
participant "<<javaScript>>\n:server" as server
participant "<<router>>\n:bookings" as routerBookings
participant "<<middleware>>\n:auth" as middleware
participant "<<controllers>>\n:bookings" as controllersBookings
participant "<<model>>\n:Campground" as modelCampground
participant "<<model>>\n:Booking" as modelBooking
database "<<MongoDB>>\n:bookings" as BookingsDatabase

client->server ++:req.post('/api/v1/campgrounds/:campgroundId/bookings')
server->routerBookings ++:app.use('/api/v1/campgrounds/:campgroundId/bookings', bookings)

routerBookings -> middleware ++:protect()
routerBookings <- middleware --:next()

routerBookings -> controllersBookings ++:addBooking()

controllersBookings -> modelCampground ++:findById(req.params.campgroundId)
modelCampground -> BookingsDatabase ++: CampgroundSchema
BookingsDatabase --> modelCampground --: campground
controllersBookings <-- modelCampground --: campground

alt campground not found
controllersBookings -> client : response (404, success: false, msg: 'Can't find Campground')
else campground found

controllersBookings -> modelBooking ++:find({user: req.user.id})
modelBooking -> BookingsDatabase ++: BookingSchema
BookingsDatabase --> modelBooking --: existing_bookings
controllersBookings <-- modelBooking --: existing_bookings

alt count >= 3 AND role != 'admin'
    controllersBookings -> client : response (400, success: false, msg: 'hit the limit')
else authorized to book
    controllersBookings -> modelBooking ++:create(req.body)
    modelBooking -> BookingsDatabase ++: BookingSchema
    BookingsDatabase --> modelBooking --: booking
    controllersBookings <-- modelBooking --: booking
    controllersBookings -> client --: response (201, success: true, data: booking)
end
end

@enduml